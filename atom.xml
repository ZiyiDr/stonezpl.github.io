<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>张珮磊想静静</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://stonezpl.github.io/"/>
  <updated>2019-04-16T16:34:06.418Z</updated>
  <id>https://stonezpl.github.io/</id>
  
  <author>
    <name>张珮磊</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>springboot(一)——搭建属于自己的springboot项目</title>
    <link href="https://stonezpl.github.io/2019/04/16/springboot/"/>
    <id>https://stonezpl.github.io/2019/04/16/springboot/</id>
    <published>2019-04-16T14:46:15.000Z</published>
    <updated>2019-04-16T16:34:06.418Z</updated>
    
    <content type="html"><![CDATA[<h2 id="idea使用spring-Initalizr-快速构建spring-boot"><a href="#idea使用spring-Initalizr-快速构建spring-boot" class="headerlink" title="idea使用spring Initalizr 快速构建spring boot"></a>idea使用spring Initalizr 快速构建spring boot</h2><ol><li>点击新建项目,选择如图所示<img src="/2019/04/16/springboot/springboot001.png" alt></li><li>点击next后<img src="/2019/04/16/springboot/springboot002.png" alt><a id="more"></a></li><li>点击next，之后按照图中所示选择<img src="/2019/04/16/springboot/springboot003.png" alt></li><li>选择路径<img src="/2019/04/16/springboot/springboot004.png" alt></li><li>点击完成，如图所示，删除自己不想要的，项目构建完成<img src="/2019/04/16/springboot/springboot005.png" alt></li><li>构建一个controller，启动项目就可以看到返回结果了<br><img src="/2019/04/16/springboot/springboot006.png" alt></li></ol><h2 id="在自己的服务器搭建自己的springboot项目"><a href="#在自己的服务器搭建自己的springboot项目" class="headerlink" title="在自己的服务器搭建自己的springboot项目"></a>在自己的服务器搭建自己的springboot项目</h2><h3 id="使用idea向远程服务传递项目"><a href="#使用idea向远程服务传递项目" class="headerlink" title="使用idea向远程服务传递项目"></a>使用idea向远程服务传递项目</h3><ol><li>设置idea<img src="/2019/04/16/springboot/springboot007.png" alt></li><li>配置相关信息<img src="/2019/04/16/springboot/springboot008.png" alt></li><li>上传到指定机器<img src="/2019/04/16/springboot/2019-04-17-00-09-25.png" alt></li></ol><h3 id="配置启动脚本，基于java-jar命令"><a href="#配置启动脚本，基于java-jar命令" class="headerlink" title="配置启动脚本，基于java -jar命令"></a>配置启动脚本，基于java -jar命令</h3><ul><li><p>start.sh</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">nohup java -jar target/zplxjj.jar  &amp;</span><br></pre></td></tr></table></figure></li><li><p>stop.sh</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">PID=$(ps -ef | grep target/zplxjj.jar | grep -v grep | awk &apos;&#123; print $2 &#125;&apos;)</span><br><span class="line">if [ -z &quot;$PID&quot; ]</span><br><span class="line">then</span><br><span class="line">    echo Application is already stopped</span><br><span class="line">else</span><br><span class="line">    echo kill $PID</span><br><span class="line">    kill $PID</span><br><span class="line">fi</span><br><span class="line">~</span><br></pre></td></tr></table></figure></li><li><p>run.sh</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">echo stop application</span><br><span class="line">source stop.sh</span><br><span class="line">echo start application</span><br><span class="line">source start.sh</span><br></pre></td></tr></table></figure></li></ul><p>启动自己的项目只需要执行run.sh就行，一个自己的spring boot就搭建起来了</p><h2 id="logback配置"><a href="#logback配置" class="headerlink" title="logback配置"></a>logback配置</h2><p>实际项目中，我们希望日志可以记录在服务器上面，这边用的是logback，是springboot自带的，我这边集成方式是加入logback-spring.xml文件，加入后启动项目即可，文件内容如下：<br><figure class="highlight xml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span></span><br><span class="line">    <span class="hljs-comment">&lt;!--用来定义变量值的标签--&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"LOG_HOME"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"./logs"</span>/&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"encoding"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"UTF-8"</span>/&gt;</span></span><br><span class="line">    <span class="hljs-comment">&lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度；%M:%L是方法和行号；%msg是日志消息；%n是换行符--&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"normal-pattern"</span></span></span><br><span class="line"><span class="hljs-tag">              <span class="hljs-attr">value</span>=<span class="hljs-string">"%d&#123;yyyy-MM-dd/HH:mm:ss.SSS&#125;|%X&#123;localIp&#125;|%X&#123;requestId&#125;|%X&#123;requestSeq&#125;|%X&#123;country&#125;|%X&#123;deviceType&#125;|%X&#123;deviceId&#125;|%X&#123;userId&#125;|^_^|[%t] %-5level %logger&#123;50&#125; %line - %m%n"</span>/&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"plain-pattern"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"%d&#123;yyyy-MM-dd.HH:mm:ss&#125; %msg%n"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">&lt;!-- 按照每天生成日志文件 --&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"FILE"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="hljs-comment">&lt;!--日志文件输出的文件名--&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>$&#123;LOG_HOME&#125;/zplxjj.log<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">Append</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">Append</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">prudent</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">prudent</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.classic.encoder.PatternLayoutEncoder"</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>$&#123;normal-pattern&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">charset</span>&gt;</span>$&#123;encoding&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">charset</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span></span><br><span class="line">        <span class="hljs-comment">&lt;!--按时间分割--&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">rollingPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">fileNamePattern</span>&gt;</span>$&#123;LOG_HOME&#125;/zplxjj.log.%d&#123;yyyy-MM-dd&#125;.%i<span class="hljs-tag">&lt;/<span class="hljs-name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">maxFileSize</span>&gt;</span>128MB<span class="hljs-tag">&lt;/<span class="hljs-name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">maxHistory</span>&gt;</span>15<span class="hljs-tag">&lt;/<span class="hljs-name">maxHistory</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">totalSizeCap</span>&gt;</span>32GB<span class="hljs-tag">&lt;/<span class="hljs-name">totalSizeCap</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;/<span class="hljs-name">rollingPolicy</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">&lt;!--控制台输出--&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"STDOUT"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.classic.encoder.PatternLayoutEncoder"</span>&gt;</span></span><br><span class="line">            <span class="hljs-comment">&lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>$&#123;normal-pattern&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">&lt;!-- log file error --&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ERROR"</span></span></span><br><span class="line"><span class="hljs-tag">              <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.classic.filter.ThresholdFilter"</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>ERROR<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>$&#123;LOG_HOME&#125;/zplxjj-error.log<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">prudent</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">prudent</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">Append</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">Append</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>$&#123;normal-pattern&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">charset</span>&gt;</span>$&#123;encoding&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">charset</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">rollingPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">fileNamePattern</span>&gt;</span>$&#123;LOG_HOME&#125;/zplxjj-error.log.%d&#123;yyyy-MM-dd&#125;.%i<span class="hljs-tag">&lt;/<span class="hljs-name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">maxFileSize</span>&gt;</span>128MB<span class="hljs-tag">&lt;/<span class="hljs-name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">maxHistory</span>&gt;</span>15<span class="hljs-tag">&lt;/<span class="hljs-name">maxHistory</span>&gt;</span></span><br><span class="line">            <span class="hljs-tag">&lt;<span class="hljs-name">totalSizeCap</span>&gt;</span>32GB<span class="hljs-tag">&lt;/<span class="hljs-name">totalSizeCap</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;/<span class="hljs-name">rollingPolicy</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"INFO"</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"STDOUT"</span>/&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"FILE"</span>/&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"ERROR"</span>/&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>效果如图：<br><img src="/2019/04/16/springboot/springboot010.png" alt></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;idea使用spring-Initalizr-快速构建spring-boot&quot;&gt;&lt;a href=&quot;#idea使用spring-Initalizr-快速构建spring-boot&quot; class=&quot;headerlink&quot; title=&quot;idea使用spring Initalizr 快速构建spring boot&quot;&gt;&lt;/a&gt;idea使用spring Initalizr 快速构建spring boot&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;点击新建项目,选择如图所示&lt;img src=&quot;/2019/04/16/springboot/springboot001.png&quot; alt&gt;&lt;/li&gt;
&lt;li&gt;点击next后&lt;img src=&quot;/2019/04/16/springboot/springboot002.png&quot; alt&gt;&lt;/li&gt;&lt;/ol&gt;
    
    </summary>
    
      <category term="springboot" scheme="https://stonezpl.github.io/categories/springboot/"/>
    
    
  </entry>
  
  <entry>
    <title>redis分布式锁——简单实现</title>
    <link href="https://stonezpl.github.io/2019/04/03/redis/"/>
    <id>https://stonezpl.github.io/2019/04/03/redis/</id>
    <published>2019-04-03T08:32:01.000Z</published>
    <updated>2019-04-03T12:20:42.078Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近项目当中需要处理分布式系统中的并发问题，自然地想到了引入分布式锁，本文旨在讲述用redis简单的实现分布式锁，对于复杂的类似于redis集群问题、为什么不用zk等，自己也在学习，希望可以以后有机会分享</p><h2 id="分布式锁的可靠性保证"><a href="#分布式锁的可靠性保证" class="headerlink" title="分布式锁的可靠性保证"></a>分布式锁的可靠性保证</h2><ol><li>在过期时间内，只有一个客户端持有锁</li><li>在客户端持有锁期间短暂崩溃或者redis发生短暂崩溃时，不会有死锁状态</li><li>加锁和解锁必须是同一客户端，加锁和解锁必须是同一个客户端</li></ol><a id="more"></a><h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><blockquote><p>项目当中的实现<br><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Boolean <span class="hljs-title">lock</span><span class="hljs-params">(String key)</span> </span>&#123;</span><br><span class="line">    Long nowTIme = System.nanoTime();</span><br><span class="line">    <span class="hljs-comment">//TIMEOUT_NANO：超时时间</span></span><br><span class="line">    <span class="hljs-keyword">while</span> (TIMEOUT_NANO &gt; System.nanoTime() - nowTIme) &#123;</span><br><span class="line">        <span class="hljs-keyword">long</span> expires = System.nanoTime() + EXPIRE_NANO;</span><br><span class="line">        <span class="hljs-comment">//锁到期时间</span></span><br><span class="line">        String expiresStr = String.valueOf(expires);</span><br><span class="line">        <span class="hljs-comment">//putIfAbsent: setnx命令</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (putIfAbsent(key, expiresStr)) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-comment">//当redis存在这个key的时候，取出这个key，判断是否超时</span></span><br><span class="line">        String currentValue = get(key);</span><br><span class="line">        <span class="hljs-comment">//判断锁是否已经过期，过期则重新设置并获取</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (currentValue != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">            <span class="hljs-keyword">if</span>(Long.parseLong(currentValue) &lt; System.nanoTime() - EXPIRE_NANO)&#123;</span><br><span class="line">                <span class="hljs-comment">//设置锁并返回旧值：getSet</span></span><br><span class="line">                String oldValue = getAndSet(key, expiresStr);</span><br><span class="line">                <span class="hljs-comment">//比较锁的时间，如果不一致则可能是其他锁已经修改了值并获取</span></span><br><span class="line">                <span class="hljs-keyword">if</span> (oldValue != <span class="hljs-keyword">null</span> &amp;&amp; oldValue.equals(currentValue)) &#123;</span><br><span class="line">                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="hljs-keyword">else</span> &#123;</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"get redis lock timeout,key=["</span> + key + <span class="hljs-string">"]"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Boolean <span class="hljs-title">unlock</span><span class="hljs-params">(String key)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (StringUtils.isBlank(key)) &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">try</span> &#123;</span><br><span class="line">        <span class="hljs-comment">//redis的del命令</span></span><br><span class="line">        del(key);</span><br><span class="line">    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="hljs-string">"redis unlock exception, key=&#123;&#125;"</span>, key, e);</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p> 项目中代码存在的问题</p><ol><li>过期时间调用的是: System.nanoTime(),这就需要客户端的时间必须同步</li><li>getAndSet 虽然只有一个客户端可以获取锁，但是会覆盖过期时间</li><li>锁不具备拥有者标识，相当于所有客户端都拥有相同的key，且对应的value区分不出客户端，即任何客户端都可以解锁。举例：<strong>客户端A加锁，一段时间之后客户端A解锁，在执行删除key之前，锁突然过期了，此时客户端B尝试加锁成功，然后客户端A再执行del()方法，则将客户端B的锁给解除了。</strong></li></ol></blockquote><blockquote><p>加锁过程优化</p><ol><li>加锁原理：基于redis的set命令，value为每个客户端唯一的id，10000为过期时间，相当于setex和setnx两条命令的整合<img src="/2019/04/03/redis/redis001.png" alt></li><li>解锁原理(摘抄网上一段方法)<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//eval命令执行Lua代码的时候，Lua代码将被当成一个命令去执行，并且直到eval命令执行完成，Redis才会执行其他命令,保证了其原子性</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">del</span><span class="hljs-params">(Jedis jedis, String key, String requestId)</span> </span>&#123;</span><br><span class="line">        String script = <span class="hljs-string">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span>;</span><br><span class="line">        Object result = jedis.eval(script, Collections.singletonList(lockKey), Collections.singletonList(requestId));</span><br><span class="line">        <span class="hljs-keyword">if</span> (RELEASE_SUCCESS.equals(result)) &#123;</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ol></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;最近项目当中需要处理分布式系统中的并发问题，自然地想到了引入分布式锁，本文旨在讲述用redis简单的实现分布式锁，对于复杂的类似于redis集群问题、为什么不用zk等，自己也在学习，希望可以以后有机会分享&lt;/p&gt;
&lt;h2 id=&quot;分布式锁的可靠性保证&quot;&gt;&lt;a href=&quot;#分布式锁的可靠性保证&quot; class=&quot;headerlink&quot; title=&quot;分布式锁的可靠性保证&quot;&gt;&lt;/a&gt;分布式锁的可靠性保证&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;在过期时间内，只有一个客户端持有锁&lt;/li&gt;
&lt;li&gt;在客户端持有锁期间短暂崩溃或者redis发生短暂崩溃时，不会有死锁状态&lt;/li&gt;
&lt;li&gt;加锁和解锁必须是同一客户端，加锁和解锁必须是同一个客户端&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="redis" scheme="https://stonezpl.github.io/categories/redis/"/>
    
    
  </entry>
  
  <entry>
    <title>linux 常用命令(持续更新)</title>
    <link href="https://stonezpl.github.io/2019/04/01/linux/"/>
    <id>https://stonezpl.github.io/2019/04/01/linux/</id>
    <published>2019-04-01T12:48:19.000Z</published>
    <updated>2019-04-03T14:28:49.250Z</updated>
    
    <content type="html"><![CDATA[<h1 id="查看磁盘空间大小"><a href="#查看磁盘空间大小" class="headerlink" title="查看磁盘空间大小"></a>查看磁盘空间大小</h1><ol><li>查看磁盘空间大小: df -h<img src="/2019/04/01/linux/linux001.png" alt></li><li>查看指定目录大小: du -sh &lt;目录名&gt;<img src="/2019/04/01/linux/linux002.png" alt><a id="more"></a></li><li>du -h [目录名]：查看指定文件夹下的所有文件大小（包含子文件夹)</li><li>对文件大小进行排序(进入当前目录下)：<img src="/2019/04/01/linux/linux003.png" alt></li></ol><h1 id="文本查询相关"><a href="#文本查询相关" class="headerlink" title="文本查询相关"></a>文本查询相关</h1><ol><li>统计某个词出现频率<img src="/2019/04/01/linux/linux004.png" alt></li><li>统计单词次数并按次数排序(每一行为一个单词):<img src="/2019/04/01/linux/linux005.png" alt></li><li>按照分隔符分词，然后排序，去重：<img src="/2019/04/01/linux/linux006.png" alt></li></ol><h1 id="查看端口占用"><a href="#查看端口占用" class="headerlink" title="查看端口占用"></a>查看端口占用</h1><ol><li>查看端口占用进程和进程占用端口<img src="/2019/04/01/linux/linux007.png" alt></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;查看磁盘空间大小&quot;&gt;&lt;a href=&quot;#查看磁盘空间大小&quot; class=&quot;headerlink&quot; title=&quot;查看磁盘空间大小&quot;&gt;&lt;/a&gt;查看磁盘空间大小&lt;/h1&gt;&lt;ol&gt;
&lt;li&gt;查看磁盘空间大小: df -h&lt;img src=&quot;/2019/04/01/linux/linux001.png&quot; alt&gt;&lt;/li&gt;
&lt;li&gt;查看指定目录大小: du -sh &amp;lt;目录名&amp;gt;&lt;img src=&quot;/2019/04/01/linux/linux002.png&quot; alt&gt;&lt;/li&gt;&lt;/ol&gt;
    
    </summary>
    
      <category term="linux" scheme="https://stonezpl.github.io/categories/linux/"/>
    
    
  </entry>
  
</feed>
